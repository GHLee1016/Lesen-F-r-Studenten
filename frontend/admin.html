<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin — Levels</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--line:#e7e9ef;--txt:#111;--sub:#666;--blue:#2b8cff;--green:#00b470;--amber:#ffb300;--red:#e2475d;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    #wrap{max-width:1100px;margin:24px auto;background:var(--card);border-radius:12px;padding:16px 20px;box-shadow:0 8px 30px rgba(0,0,0,.06)}
    h3,h4{margin:8px 0}
    .row{display:flex;gap:8px;align-items:center;margin:8px 0;flex-wrap:wrap}
    input[type="text"],select{height:34px;padding:6px 8px;border:1px solid var(--line);border-radius:8px}
    input#token{width:220px}
    button{height:34px;padding:0 10px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer}
    button.primary{background:var(--blue);color:#fff;border-color:var(--blue)}
    .cols{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
    .card{border:1px solid var(--line);border-radius:10px;padding:12px;min-height:200px;background:#fff}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .tag.high{background:rgba(0,180,112,.12);color:var(--green);border:1px solid rgba(0,180,112,.35)}
    .tag.medium{background:rgba(255,179,0,.12);color:var(--amber);border:1px solid rgba(255,179,0,.35)}
    .tag.low{background:rgba(226,71,93,.12);color:var(--red);border:1px solid rgba(226,71,93,.35)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid var(--line);font-size:14px}
    th{text-align:left;color:var(--sub);font-weight:600}
    .muted{color:var(--sub)}
    @media (max-width:960px){.cols{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div id="wrap">
    <div class="row">
      <h3 style="margin-right:auto">Users by Level</h3>
      <label>Admin Token</label>
      <input id="token" type="text" placeholder="Enter admin token..."/>
      <button id="btnRefresh">Refresh</button>
      <button id="btnCsv">Export CSV</button>
      <button id="btnJson">Export JSON</button>
    </div>

    <div class="row">
      <label>Variant</label>
      <select id="variant">
        <option value="all">All</option>
        <option value="b1">b1</option>
        <option value="b1plus">b1+</option>
      </select>
      <div style="flex:1"></div>
      <label>High ≥</label><input id="hi" type="text" value="70" style="width:72px"/>
      <label>Low <</label><input id="lo" type="text" value="40" style="width:72px"/>
      <button id="btnApply" class="primary">Apply</button>
      <span id="msg" class="muted"></span>
    </div>

    <div class="cols">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h4>High</h4><span class="tag high">≥ High</span>
        </div>
        <table><thead><tr><th>User</th><th>EMA</th><th>Variant</th></tr></thead><tbody id="high"></tbody></table>
      </div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h4>Medium</h4><span class="tag medium">[Low, High)</span>
        </div>
        <table><thead><tr><th>User</th><th>EMA</th><th>Variant</th></tr></thead><tbody id="medium"></tbody></table>
      </div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h4>Low</h4><span class="tag low">< Low</span>
        </div>
        <table><thead><tr><th>User</th><th>EMA</th><th>Variant</th></tr></thead><tbody id="low"></tbody></table>
      </div>
    </div>
  </div>

  <script>
    const ORIGIN = "https://localhost:8443";
    const ADMIN_WS = ORIGIN.replace("https","wss") + "/admin/ws";

    const tokenEl = document.getElementById("token");
    const variantSel = document.getElementById("variant");
    const hiEl = document.getElementById("hi");
    const loEl = document.getElementById("lo");
    const msgEl = document.getElementById("msg");
    const tbody = {
      high: document.getElementById("high"),
      medium: document.getElementById("medium"),
      low: document.getElementById("low"),
    };

    // [신규] 가져온 데이터를 저장할 전역 변수
    let allGroupsData = {};

    function setMsg(s, ok=true){ msgEl.textContent=s; msgEl.style.color = ok ? "#2b8cff" : "crimson"; if(s) setTimeout(()=>msgEl.textContent="",2000); }
    
    // [수정] render 함수는 이제 전역 변수 대신 '받아온' 데이터를 사용
    function render(groups){
      const want = variantSel.value;
      ["high","medium","low"].forEach(lv=>{
        const rows = (groups[lv]||[])
          .filter(it => want==="all" ? true : it.variant===want)
          .map(it => `<tr><td>${it.user_id}</td><td>${it.ema}</td><td class="muted">${it.variant}</td></tr>`)
          .join("");
        tbody[lv].innerHTML = rows || `<tr><td class="muted" colspan="3">No users</td></tr>`;
      });
    }

    async function fetchJSON(url, opts={}){
      const res = await fetch(url, opts);
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    async function refresh(){
      try {
        const data = await fetchJSON(`${ORIGIN}/admin/levels`, { headers: {"X-Admin-Token": tokenEl.value.trim()} });
        allGroupsData = data; // [수정] 데이터를 전역 변수에 저장
        render(allGroupsData); // 저장된 데이터로 렌더링
      } catch (e) {
        setMsg("Auth/connection error", false);
        allGroupsData = {}; // 오류 시 데이터 비우기
        render(allGroupsData);
      }
    }

    async function applyThresholds(){
      const hi = parseFloat(hiEl.value), lo = parseFloat(loEl.value);
      const res = await fetch(`${ORIGIN}/admin/levels/config`, {
        method:"POST",
        headers: {"Content-Type":"application/json","X-Admin-Token": tokenEl.value.trim()},
        body: JSON.stringify({ high: hi, low: lo })
      });
      setMsg(res.ok ? "Updated" : "Update failed", res.ok);
    }
    function download(url){ const a=document.createElement("a"); a.href=url; a.setAttribute("download",""); a.click(); }

    document.getElementById("btnRefresh").onclick = refresh;
    document.getElementById("btnApply").onclick = applyThresholds;
    document.getElementById("btnCsv").onclick = ()=> download(`${ORIGIN}/admin/levels/export.csv`);
    document.getElementById("btnJson").onclick = ()=> download(`${ORIGIN}/admin/levels/export.json`);
    
    // [수정] Variant 변경 시 서버 요청(refresh) 대신 로컬 렌더링(render) 호출
    variantSel.onchange = () => render(allGroupsData);

    let ws;
    function connectWS(){
      // [수정] WS 연결 시 토큰 사용
      const token = tokenEl.value.trim();
      if (!token) {
        setMsg("Token required for WebSocket", false);
        // 토큰이 없으면 1.5초 후 다시 시도 (토큰 입력 대기)
        setTimeout(connectWS, 1500);
        return;
      }
      
      // [수정] 쿼리 파라미터로 토큰 전송
      ws = new WebSocket(`${ADMIN_WS}?token=${encodeURIComponent(token)}`);

      ws.onmessage = (e)=>{
        const msg = JSON.parse(e.data);
        if(msg.type === "groups") {
          allGroupsData = msg.data; // WS로 받은 데이터도 전역 변수 업데이트
          render(allGroupsData);
        }
        if(msg.type === "score_update") {
          refresh(); // 점수 업데이트 시엔 새로고침 (권장)
        }
      };
      
      ws.onclose = ()=> setTimeout(connectWS, 1500);
      
      ws.onerror = (e) => {
        console.warn("WS Error", e);
        // (참고) 서버에서 토큰 인증 실패 시 여기서 연결을 강제로 닫을 수 있음
      };
    }

    connectWS();
    refresh(); // 초기 로드
  </script>
</body>
</html>